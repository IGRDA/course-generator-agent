---
globs: agents/**/*.py
---

# Agent Development Patterns

Follow these patterns when developing new agents or modifying existing ones.

## Agent Structure Template
Every agent directory should contain:
```
agents/{agent_name}/
├── agent.py      # Main agent logic and LLM integration
├── prompts.py    # LangChain PromptTemplate definitions
├── utils.py      # Agent-specific utilities (optional)
└── __init__.py   # Package initialization
```

## Agent Implementation Patterns

### LLM Integration
- Use `ChatMistralAI` from `langchain_mistralai`
- Set model via `MISTRAL_MODEL_NAME` environment variable (defaults: `"mistral-small-latest"`)
- Configure appropriate temperature (0.5 for structured output, 0.7 for creative content)

### Error Handling
- Use `RetryWithErrorOutputParser` for Pydantic output parsing
- Implement configurable `max_retries` parameter
- Provide fallback content for failed generations
- Log errors with descriptive context

### Prompt Design
- Use `PromptTemplate.from_template()` from LangChain
- Include clear instructions and format requirements
- Support multi-language content generation
- Separate templates for generation and retry scenarios

### State Integration
- Accept and return `CourseState` objects
- Modify state in-place for efficiency
- Preserve all state fields during operations
- Use type hints for clarity

### Async Support
- Implement async functions for LLM calls (`await llm.ainvoke()`)
- Use semaphores for concurrency control
- Handle parallel execution patterns
- Provide progress feedback via print statements

## Example Agent Function Signature
```python
async def generate_content(
    course_state: CourseState,
    context_params: dict,
    max_retries: int = 3
) -> CourseState:
    """Generate content and update course state."""
```

## Integration with Workflow
- Agents are called from [main/workflow.py](mdc:main/workflow.py) nodes
- Must accept and return `CourseState` 
- Should be stateless (no persistent instance state)
- Support both sync and async execution patterns