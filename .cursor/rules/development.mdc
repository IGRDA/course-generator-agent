---
alwaysApply: true
---

# Development Guidelines

Essential patterns and guidelines for developing in this course generator codebase.

## Environment Setup

### Required Environment Variables
```bash
export MISTRAL_API_KEY="your_mistral_api_key_here"
export MISTRAL_MODEL_NAME="mistral-small-latest"  # Optional
```

### Installation
```bash
pip install -e .  # Editable install for development
```

### Project Dependencies
- **Core**: `langchain`, `langchain-mistralai`, `pydantic`, `langgraph`
- **Optional Visualization**: `pygraphviz` (requires `brew install graphviz`)
- **Development**: Use [notebooks/](mdc:notebooks/) for experimentation

## Code Style and Conventions

### Import Organization
```python
# Standard library
import os
import asyncio

# Third-party packages  
from langchain_mistralai import ChatMistralAI
from langchain.output_parsers import PydanticOutputParser
from pydantic import BaseModel, Field

# Local imports
from main.state import CourseState
from .prompts import your_prompt_template
```

### Type Hints
- Use type hints consistently, especially for `CourseState`
- Use `str | None` for optional strings (Python 3.10+ syntax)
- Use `List[Type]` for lists in Pydantic models

### Function Documentation
```python
async def generate_content(
    course_state: CourseState,
    context: dict,
    max_retries: int = 3
) -> CourseState:
    """
    Generate content for the course state.
    
    Args:
        course_state: The current course state
        context: Additional context for generation
        max_retries: Maximum number of retry attempts
        
    Returns:
        Updated course state with generated content
    """
```

## Testing and Development

### Development Workflow
1. Use [main/workflow.py](mdc:main/workflow.py) main block for testing
2. Create small test cases in [notebooks/](mdc:notebooks/) 
3. Test with minimal parameters first (small page counts)
4. Gradually increase complexity

### Debugging Tips
- Use `print()` statements for progress tracking
- Check `CourseState` serialization with `.model_dump_json(indent=2)`
- Test individual agents before workflow integration
- Use small concurrency values during development

### Configuration for Testing
```python
# Minimal test configuration
test_state = CourseState(
    title="Test Course",
    n_modules=1, n_submodules=1, n_sections=1, n_words=100,
    modules=[],
    total_pages=5,  # Small for fast testing
    concurrency=1,  # Sequential for debugging
    language="English"
)
```

## Error Handling Standards

### Logging Pattern
```python
try:
    result = await process_item(item)
    print(f"✓ Success: {context}")
    return result
except Exception as e:
    print(f"✗ Error in {context}: {e}")
    return fallback_value
```

### Graceful Degradation
- Always provide fallback content for failed generations
- Continue processing other items when one fails
- Make retry attempts configurable
- Log errors with sufficient context for debugging

## Extension Guidelines

### Adding New Agents
1. Create directory: `agents/{agent_name}/`
2. Required files: `agent.py`, `prompts.py`, `__init__.py`  
3. Follow patterns from existing agents
4. Update workflow in [main/workflow.py](mdc:main/workflow.py)
5. Test integration thoroughly

### Adding New Tools
1. Add to [tools/](mdc:tools/) directory
2. Make them importable from multiple agents
3. Follow async patterns if they involve I/O
4. Document usage patterns

### State Model Changes
1. Modify [main/state.py](mdc:main/state.py) models
2. Use `Field(default=...)` for backward compatibility
3. Update all agents that use modified fields
4. Test serialization/deserialization

## Performance Considerations
- Default concurrency of 8 for parallel operations
- Monitor API rate limits with Mistral AI
- Use appropriate model sizes (small/medium/large)
- Consider memory usage for large course structures

## Common Pitfalls to Avoid
- Don't modify state structure during parallel operations
- Always use semaphores for concurrent API calls
- Don't forget language constraints in prompts
- Test with different languages and character sets
- Handle empty or malformed LLM responses gracefully